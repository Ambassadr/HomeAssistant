# @Author: Will Scott <willscottuk>
# @Date:   12/06/2017 21:52
# @Project: Ambassadr Home Automation
# @Last modified by:   willscott
# @Last modified time: 28/02/2018 21:19

# This package deals with time and all time-based automations

input_boolean:
  good_morning:
    icon: mdi:weather-sunny
  good_night:
    icon: mdi:weather-night

# Horrible duplication because of bugs (#239)
switch:
  - platform: template
    switches:
      good_morning:
        value_template: "{{ is_state('input_boolean.good_morning', 'on') }}"
        turn_on:
          service: input_boolean.turn_on
          data:
            entity_id: input_boolean.good_morning
        turn_off:
          service: switch.turn_off
          data:
            entity_id: input_boolean.good_morning
      good_night:
        value_template: "{{ is_state('input_boolean.good_night', 'on') }}"
        turn_on:
          service: input_boolean.turn_on
          data:
            entity_id: input_boolean.good_night
        turn_off:
          service: switch.turn_off
          data:
            entity_id: input_boolean.good_night

# This sensor is what allows HASS to know what time it is (and date, day of week etc.)
sensor:
  - platform: time_date
    display_options:
      - 'time'

scene:
  - name: Good Night Lights
    entities:
      group.living_room:
        state: off
        transition: 30
      group.kitchen:
        state: off
        transition: 30
      group.hall:
        state: off
        transition: 45
      group.map:
        state: off
        transition: 45
      group.bedroom:
        state: off
        transition: 60
      group.ensuite:
        state: off
        transition: 30
      group.bathroom:
        state: off
        transition: 30
      group.utility:
        state: off
        transition: 30
  - name: Good Morning Lights
    entities:
      group.kitchen:
        state: on
      group.bedroom:
        state: on

script:
  morning_tv:
    sequence:
      - service: remote.turn_on
        entity_id: "remote.living_room"
        data:
          activity: "Watch TV"
      - delay: 0:00:10
      - service: media_player.select_source
        entity_id: media_player.livingroomtv
        data:
          source: "LiveTV"
      - delay: 0:00:05
      - service: remote.send_command
        entity_id: remote.living_room
        data:
          device: "41500380"
          command: "1"

#    Automatic Time Modes
#
#    04:30 until sunrise*: Dawn
#    Sunrise until midday: Morning
#    Midday until sunset: Afternoon
#    Sunset* until 22:00: Evening
#    22:00 until 04:30: Night
#
#    *Note: Due to geographical location, sunrise never takes place prior to 04:30 and sunset never takes place after 22:00. These modes are therefore location appropriate. Your milage may vary...

input_select:
  time_mode:
    name: Time Mode
    options:
      - Dawn
      - Morning
      - Afternoon
      - Evening
      - Night

# These are then the time-based automations

automation:

# 1: 04:30: Reset everything (but not guest_mode or holiday_mode), turn on dawn_mode and turn off night_mode.
# Aside: this is also when the presence module checks to see if anyone is home - if not then holiday_mode is automagically switched on.

  - alias: 'Morning Reset'
    trigger:
        platform: time
        at: '04:30:00'
    condition:
      - condition: time
        before: '06:00:00'
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Dawn
      - service: input_boolean.turn_off
        entity_id:
          - input_boolean.romance_mode
          - input_boolean.party_mode
          - input_boolean.quiet_mode
      # This should have been covered off at evening -> night but just in case
      - service: input_select.select_option
        entity_id: input_select.sunset_phase
        data:
          option: Unset
      - service: input_select.select_option
        entity_id: input_select.cloud_cover
        data:
          option: Unset
      # Reset SONOS volumes
      - service: media_player.volume_set
        entity_id:
          - media_player.living_room_one
          - media_player.bedroom_one
        data:
          volume_level: "0.10"

# 2: Sunrise! Turn off Danw and turn on Morning.

  - alias: 'Morning Mode'
    trigger:
      platform: numeric_state
      entity_id: sun.sun
      value_template: '{{ state.attributes.elevation }}'
      above: 0.1
    condition:
      # This is just a safety catch for when HASS restarts
      - condition: time
        before: '12:00:00'
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Morning

# 3: Midday: Turn off Morning and turn on Afternoon.

  - alias: "Afternoon Mode"
    trigger:
      - platform: time
        at: '12:00:00'
    condition:
      - condition: time
        before: '16:30:00'
      - condition: time
        after: '12:00:00'
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Afternoon

# 4: Sunset(ish): Set mode to evening.

# This isn't actually sunset but when the sunset automations kick in (see packages/sunset) which are weather dependent.

  - alias: 'Evening Mode'
    trigger:
      platform: state
      entity_id: input_select.sunset_phase
      to: Early Twilight
    condition:
      - condition: time
        before: '22:00:00'
      - condition: time
        after: '15:00:00'
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Evening

# 5: Night mode: Set mode to night. Also turns off dusk.

  - alias: "Night Mode"
    trigger:
      - platform: time
        at: '22:00:00'
    condition:
      - condition: time
        before: '23:59:00'
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Night
      - service: input_select.select_option
        entity_id: input_select.sunset_phase
        data:
          option: Unset
      - service: input_select.select_option
        entity_id: input_select.cloud_cover
        data:
          option: Unset

# Automations to set the mode correctly at startup

  - alias: 'Auto Dawn Mode'
    trigger:
      platform: homeassistant
      event: start
    condition:
      - condition: time
        after: '04:30:00'
      - condition: time
        before: '12:00:00'
      - condition: numeric_state
        entity_id: sun.sun
        value_template: '{{ state.attributes.elevation }}'
        below: 0.1
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Dawn
  - alias: 'Auto Morning Mode'
    trigger:
      platform: homeassistant
      event: start
    condition:
      - condition: time
        before: '12:00:00'
      - condition: numeric_state
        entity_id: sun.sun
        value_template: '{{ state.attributes.elevation }}'
        above: 0.1
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Morning
  - alias: 'Auto Afternoon Mode'
    trigger:
      platform: homeassistant
      event: start
    condition:
      - condition: time
        after: '12:00:00'
      # This isn't strictly right, but as an approximation it's okay.
      - condition: numeric_state
        entity_id: sun.sun
        value_template: '{{ state.attributes.elevation }}'
        above: 0.1
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Afternoon
  - alias: 'Auto Evening Mode'
    trigger:
      platform: homeassistant
      event: start
    condition:
      - condition: time
        before: '22:00:00'
      - condition: time
        after: '12:00:00'
      # This isn't strictly right, but as an approximation it's okay.
      - condition: numeric_state
        entity_id: sun.sun
        value_template: '{{ state.attributes.elevation }}'
        below: 0.1
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Evening
  - alias: 'Auto Night Mode PM'
    trigger:
      platform: homeassistant
      event: start
    condition:
      - condition: time
        after: '22:00:00'
      - condition: numeric_state
        entity_id: sun.sun
        value_template: '{{ state.attributes.elevation }}'
        below: 0.1
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Night
  - alias: 'Auto Night Mode AM'
    trigger:
      platform: homeassistant
      event: start
    condition:
      - condition: time
        before: '04:30:00'
      - condition: numeric_state
        entity_id: sun.sun
        value_template: '{{ state.attributes.elevation }}'
        below: 0.1
    action:
      - service: input_select.select_option
        entity_id: input_select.time_mode
        data:
          option: Night

# Morning and evening switch activation (awaiting Alexa fixes)
  - alias: 'Good Morning'
    trigger:
        platform: state
        entity_id: input_boolean.good_morning
        to: 'on'
    action:
      - service: scene.turn_on
        entity_id: scene.good_morning_lights
      - service: script.morning_tv
      - service: media_player.sonos_set_sleep_timer
        entity_id:
          - media_player.bedroom_one
        data:
          sleep_time: 300

  - alias: 'Good Night'
    trigger:
        platform: state
        entity_id: input_boolean.good_night
        to: 'on'
    action:
      - service: scene.turn_on
        entity_id: scene.good_night_lights
      - service: homeassistant.turn_off
        entity_id: switch.tv
      - service: media_player.sonos_set_sleep_timer
        entity_id:
          - media_player.living_room_one
          - media_player.bedroom_one
        data:
          sleep_time: 1800
      - service: script.sonos_tts
        data_template:
          what: "Good night. Sleep tight."
          where: "bedroom_one"

# Morning and evening switch expiry (awaiting Alexa fixes)
  - alias: 'Good Morning Expiry'
    trigger:
        platform: state
        entity_id: input_boolean.good_morning
        to: 'on'
        for:
          minutes: 1
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.good_morning
  - alias: 'Good Night Expiry'
    trigger:
        platform: state
        entity_id: input_boolean.good_night
        to: 'on'
        for:
          minutes: 1
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.good_night
